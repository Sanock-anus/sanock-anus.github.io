<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBcQP8-B9zt_dKdj2Ns99H6aaqzQb8OnLc",
        authDomain: "makhovicksite.firebaseapp.com",
        projectId: "makhovicksite",
        storageBucket: "makhovicksite.firebasestorage.app",
        messagingSenderId: "245142284614",
        appId: "1:245142284614:web:fd01f94ef372ebc0ad1d47",
        databaseURL: "https://makhovicksite-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∞
    document.getElementById('c-name').onchange = function() {
        if(this.value === "–ú–ê–•‚öôÔ∏è–í–ò–ö-–∞–¥–º–∏–Ω") {
            const mail = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–æ—á—Ç—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:");
            if(mail !== "sanokgameplay@gmail.com") {
                alert("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω!");
                this.value = "";
            }
        }
    };

    // –ü–∞—Ä—Å–µ—Ä –≤–∏–¥–µ–æ
    function parseVideo(text) {
        const ytReg = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
        const match = text.match(ytReg);
        return match ? `<br><iframe width="100%" height="200" src="https://www.youtube.com/embed/${match[1]}" frameborder="0" allowfullscreen></iframe>` : "";
    }

    // –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ
    function vote(id, type, isReply = false, parentId = null) {
        let path = isReply ? `posts/${parentId}/replies/${id}/${type}` : `posts/${id}/${type}`;
        db.ref(path).transaction(c => (c || 0) + 1);
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ (–≤—ã–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É)
    let currentReplyId = null;
    function openReplyForm(id) {
        const form = document.getElementById('reply-form-' + id);
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ –≤ –±–∞–∑—É
    function sendReply(parentId) {
        const n = document.getElementById('c-name').value || "–ê–Ω–æ–Ω–∏–º";
        const t = document.getElementById('r-msg-' + parentId).value;
        if(t) {
            db.ref(`posts/${parentId}/replies`).push({
                n, t, 
                time: new Date().toLocaleString(),
                likes: 0, dislikes: 0
            });
            document.getElementById('r-msg-' + parentId).value = '';
            openReplyForm(parentId);
        }
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∏–¥–∏–º–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–æ–≤
    function toggleReplies(id) {
        const box = document.getElementById('reply-box-' + id);
        box.style.display = box.style.display === 'none' ? 'block' : 'none';
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –≥–ª–∞–≤–Ω–æ–≥–æ –ø–æ—Å—Ç–∞
    document.getElementById('send-msg').onclick = () => {
        const n = document.getElementById('c-name').value;
        const t = document.getElementById('c-msg').value;
        if(n && t) {
            db.ref('posts').push({
                n, t, time: new Date().toLocaleString(),
                likes: 0, dislikes: 0
            });
            document.getElementById('c-msg').value = '';
        }
    };

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
    db.ref('posts').on('value', snap => {
        const wall = document.getElementById('posts-wall');
        wall.innerHTML = '';
        const data = snap.val();
        for(let id in data) {
            const p = data[id];
            const videoHtml = parseVideo(p.t);
            const hasReplies = p.replies ? Object.keys(p.replies).length : 0;
            
            let postHtml = `
                <div class="post" style="background:#2c3e50; padding:15px; border-radius:10px; margin-bottom:10px; border-left:4px solid #e67e22; color:white;">
                    <div style="display:flex; justify-content:space-between;"><strong>${p.n}</strong><small>${p.time}</small></div>
                    <p>${p.t}${videoHtml}</p>
                    <div style="display:flex; gap:10px;">
                        <button onclick="vote('${id}', 'likes')">üëç ${p.likes || 0}</button>
                        <button onclick="vote('${id}', 'dislikes')">üëé ${p.dislikes || 0}</button>
                        <button onclick="openReplyForm('${id}')">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
                        ${hasReplies ? `<button onclick="toggleReplies('${id}')" style="color:#f1c40f;">–û—Ç–≤–µ—Ç—ã (${hasReplies})</button>` : ''}
                    </div>
                    
                    <div id="reply-form-${id}" style="display:none; margin-top:10px;">
                        <textarea id="r-msg-${id}" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç..." style="width:100%; background:#444; color:#fff; border-radius:5px; padding:5px;"></textarea>
                        <button onclick="sendReply('${id}')" style="margin-top:5px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
                    </div>

                    <div id="reply-box-${id}" style="display:none; margin-left:40px; margin-top:10px; border-left:2px dashed #555; padding-left:10px;">
            `;

            if(p.replies) {
                for(let rId in p.replies) {
                    const r = p.replies[rId];
                    postHtml += `
                        <div class="reply" style="margin-bottom:10px; font-size:0.9em; background:rgba(255,255,255,0.05); padding:8px; border-radius:5px;">
                            <strong>${r.n}</strong>: ${r.t}
                            <div style="margin-top:5px;">
                                <button onclick="vote('${rId}', 'likes', true, '${id}')">üëç ${r.likes || 0}</button>
                                <button onclick="vote('${rId}', 'dislikes', true, '${id}')">üëé ${r.dislikes || 0}</button>
                            </div>
                        </div>
                    `;
                }
            }

            postHtml += `</div></div>`;
            wall.insertAdjacentHTML('afterbegin', postHtml);
        }
    });

    // –°—á—ë—Ç—á–∏–∫ –∏ –°–Ω–µ–≥ (–æ—Å—Ç–∞–≤—å –∫–∞–∫ –±—ã–ª–æ)
    const countRef = db.ref('downloads/total');
    countRef.on('value', (s) => document.getElementById('count-number').innerText = s.val() || 0);
    function countDl() {
        if (!localStorage.getItem('did_dl')) {
            countRef.transaction(c => (c || 0) + 1);
            localStorage.setItem('did_dl', 'true');
        }
    }
    setInterval(() => {
        const s = document.createElement('div');
        s.innerHTML = '‚ùÑ';
        s.style.cssText = `position:fixed; top:-20px; color:white; pointer-events:none; left:${Math.random()*100}vw; animation: fall ${Math.random()*3+2}s linear forwards; z-index:9999;`;
        document.body.appendChild(s);
        setTimeout(() => s.remove(), 5000);
    }, 300);
</script>
